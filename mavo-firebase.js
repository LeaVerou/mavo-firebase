"use strict";!function(){var t=window.Bliss,e=window.Mavo;e.Backend.register(t.Class({extends:e.Backend,id:"Firebase",constructor:function(r){var s=this,o=this.mavo.id||"mavo",u={};function f(e){return e?e.split(/\s+/):""===e?[]:void 0}this.ready.then(function(){var e=/^https:\/\/.*\.firebaseio\.com$/.test(r);if(e){if(!(u={apiKey:s.mavo.element.getAttribute("mv-firebase-api-key"),authDomain:s.mavo.element.getAttribute("mv-firebase-auth-domain"),databaseURL:r,storageBucket:s.mavo.element.getAttribute("mv-firebase-storage-bucket")}).apiKey)return s.mavo.error("Firebase: mv-firebase-api-key attribute missing");s.firebase.apps.length?s.app=s.firebase.initializeApp(u,"app".concat(s.firebase.apps.length)):s.app=s.firebase.initializeApp(u)}else{if(!(u=s.firebase.default.app().options).apiKey)return s.mavo.error("Firebase: apiKey missing from config");s.app=s.firebase.default}s.statusChangesCallbacks=[];var t=s.mavo.element.getAttribute("mv-unauthenticated-permissions"),i=f(s.mavo.element.getAttribute("mv-authenticated-permissions"))||["read","edit","add","delete","save","logout"],a=f(t);if(a){if(!u.authDomain&&a.includes("login"))return e?s.mavo.error("Firebase: authDomain missing from config (needed if permission 'login' is specified)"):s.mavo.error("Firebase: firebase-auth-domain attribute missing (needed if permission 'login' is specified)")}else a=u.authDomain?["read","login"]:["read"];s.defaultPermissions={authenticated:i,unauthenticated:a},s.permissions.on(s.defaultPermissions.unauthenticated),s.db=s.app.database().ref(o),u.storageBucket&&(s.storage=s.app.storage().ref(o),s.upload=function(e){var t=this.storage.child("".concat(e.name,"-").concat(Date.now()));return t.put(e).then(function(){return t.getDownloadURL()})}),s.app.auth().onAuthStateChanged(function(e){e&&(s.permissions.off(s.defaultPermissions.unauthenticated).on(s.defaultPermissions.authenticated),s.user={username:e.email,name:e.displayName,avatar:e.photoURL})},function(e){s.mavo.error("Firebase: "+e.message)});var n=s.mavo.element.getAttribute("mv-server-push");null!==n&&"false"!==n&&s.setListenForChanges(!0)})},onStatusChange:function(e){var i=this;this.statusChangesCallbacks.push(e),this.listeningOnStatus||(this.listeningOnStatus=!0,this.app.database().ref(".info/connected").on("value",function(t){i.statusChangesCallbacks.forEach(function(e){return e(t.val())})}))},setListenForChanges:function(e){var i=this;e?this.listeningForChanges||this.db.on("value",function(e){var t=e.val();1===i.compareDocRevs({_rev:i.rev},t)&&(i.rev=t._rev,i.onNewData(t))}):this.db.off(),this.listeningForChanges=e},onNewData:function(e){return this.mavo.render(e)},load:function(){var i=this;return this.db.once("value").then(function(e){var t=e.val();return t?(i.rev=t._rev||1,t):(i.rev=1,{})})},store:function(e){var t=this;return Promise.resolve().then(function(){if(t.storeData=e,t.mavo.unsavedChanges&&!t.storing)return t.storing=!0,t.put().then(function(){t.storing=!1})})},put:function(t){var i=this;return t=this.storeData||t,delete this.storeData,this.db.transaction(function(e){return i.rev=e&&Number.isInteger(e._rev)?e._rev+1:1,Object.assign(t,{_rev:i.rev})}).then(function(){if(i.storeData)return i.put()})},login:function(){var t=this;return this.ready.then(function(){if(!t.user){var e=new t.firebase.auth.GoogleAuthProvider;return t.app.auth().signInWithPopup(e).catch(function(e){return t.mavo.error("Firebase: "+e.message),Promise.reject(e)})}})},logout:function(){var t=this;return this.app.auth().signOut().then(function(){t.permissions.off(t.defaultPermissions.authenticated).on(t.defaultPermissions.unauthenticated)}).catch(function(e){t.mavo.error("Firebase: "+e.message)})},compareDocRevs:function(e,t){return e&&Number.isInteger(e._rev)?t&&Number.isInteger(t._rev)?e._rev===t._rev?0:e._rev<t._rev?1:-1:-1:1},ready:function(){var e=this;return t.include(window.firebase,"https://www.gstatic.com/firebasejs/4.6.2/firebase.js").then(function(){e.firebase=window.firebase})},static:{test:function(e){return/^(firebase|https:\/\/.*\.firebaseio\.com)$/.test(e)}}}))}();